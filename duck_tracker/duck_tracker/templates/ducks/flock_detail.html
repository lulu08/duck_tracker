{% extends 'base.html' %}

{% load humanize %}
{% load constants_tags %}
{% load static %}

{% block title %}
  Flock {{ flock }} - {{ block.super }}
{% endblock title %}

{% block content %}
<div>
  {% url 'ducks:flock-list' as back_url %}
  {% include 'components/back_btn.html' with url=back_url label="Back to Flocks" %}

  <!-- Flock Header Card -->
  <section id="flock-card" class="card shadow-sm border-0 mb-5">
    <div class="card-body p-5">
      <div class="row mb-4">
        <div class="col-md-8">
          <h1 class="card-title mb-3">{{ flock.title }}</h1>
          <div class="mb-3">
            <span class="badge bg-info">{{ flock.number_of_ducks }} ducks</span>
            {% if flock.culled_date %}
              <span class="badge bg-secondary">Culled</span>
            {% else %}
              <span class="badge bg-success">Active</span>
            {% endif %}
          </div>
          <p class="text-muted mb-2">
            <i class="bi bi-calendar-event"></i>
            Started: <strong>{{ flock.started_date|date:"F d, Y" }}</strong>
          </p>
          {% if flock.culled_date %}
            <p class="text-muted mb-0">
              <i class="bi bi-check-circle"></i>
              Culled: <strong>{{ flock.culled_date|date:"F d, Y" }}</strong>
            </p>
          {% endif %}
          {% if flock.description %}
            <hr />
            <p class="text-muted mb-4 mb-sm-0">{{ flock.description|safe }}</p>
          {% endif %}
        </div>
        <div class="col-md-4 text-end mt-3 mt-sm-0">
          <a href="{% url 'ducks:flock-edit' flock.id %}" class="btn btn-warning mb-md-1">
            <i class="bi bi-pencil"></i> Edit Flock
          </a>
          <a href="{% url 'ducks:flock-delete' flock.id %}" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Stats Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Performance Stats</h3>
    {% if flock.is_culled %}
      <span class="text-muted ms-3 ms-sm-0">Flock was culled; no new stats can be added.</span>
    {% else %}
      <a href="{% url 'ducks:stats-add' %}?flock={{ flock.id }}" class="btn btn-primary ms-3 ms-sm-0">
        <i class="bi bi-plus-circle"></i> Add Stats Entry
      </a>
    {% endif %}
  </div>

  <!-- Import/Export -->
  <div id="import-export-form" class="d-flex gap-2 align-items-center flex-wrap justify-content-between mb-4">
    <form method="post" action="{% url 'ducks:flock-export' flock.id %}" data-no-loader class="d-flex gap-2 align-items-center">
      {% csrf_token %}
      <input type="hidden" name="format" value="0" />
      <input type="hidden" name="day" value="{{ request.GET.day }}" />
      <input type="hidden" name="start_date" value="{{ request.GET.start_date }}" />
      <input type="hidden" name="end_date" value="{{ request.GET.end_date }}" />
      <input type="hidden" name="sort" value="{{ request.GET.sort }}" />
      <button type="submit" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-download"></i> Export
      </button>
    </form>

    {% if not flock.is_culled %}
      <a href="{% url 'ducks:stats-import-template' flock.id %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-upload"></i> Import
      </a>
    {% endif %}
  </div>

  <!-- Filters Form -->
  {% if stats %}
    <section id="filter-section" class="mb-4">
      <form method="get" action="#filter-section" class="row g-3 align-items-end">
        <div class="col-auto">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="start_date" name="start_date"
                min="{{ min_date|date:'Y-m-d' }}" max="{{ max_date|date:'Y-m-d' }}"
                value="{{ request.GET.start_date }}" {% if request.GET.day %}disabled{% endif %} />
        </div>
        <div class="col-auto">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" class="form-control" id="end_date" name="end_date"
                min="{{ min_date|date:'Y-m-d' }}" max="{{ max_date|date:'Y-m-d' }}"
                value="{{ request.GET.end_date }}" {% if request.GET.day %}disabled{% endif %} />
        </div>
        <div class="col-auto">
          <label for="day" class="form-label">Day (up to)</label>
          <input type="number" class="form-control" id="day" name="day" min="1"
                value="{{ request.GET.day }}" {% if has_date_filter %}disabled{% endif %} />
        </div>
        <div class="col-auto">
          <label for="sort" class="form-label">Sort By</label>
          <select class="form-select" id="sort" name="sort">
            <option value="day_asc" {% if request.GET.sort == "day_asc" %}selected{% endif %}>Day â†‘</option>
            <option value="day_desc" {% if request.GET.sort == "day_desc" %}selected{% endif %}>Day â†“</option>
            <!-- <option value="harvested_asc" {% if request.GET.sort == "harvested_asc" %}selected{% endif %}>Harvested â†‘</option>
            <option value="harvested_desc" {% if request.GET.sort == "harvested_desc" %}selected{% endif %}>Harvested â†“</option>
            <option value="percentage_asc" {% if request.GET.sort == "percentage_asc" %}selected{% endif %}>% Production â†‘</option>
            <option value="percentage_desc" {% if request.GET.sort == "percentage_desc" %}selected{% endif %}>% Production â†“</option> -->
          </select>
        </div>
        <div class="col-auto">
          <a href="{% url 'ducks:flock-detail' flock.id %}#filter-section" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Clear Filters
          </a>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-funnel"></i> Apply Filters
          </button>
        </div>
      </form>
    </section>
  {% endif %}

  <!-- Aggregate Info Card -->
  {% include 'components/flock_info_card.html' with flock=aggregates card_id="card-info{{ flock.id }}" %}

  <!-- Charts -->
  {% if flock_stats %}
    <section id="chart-tab" class="card shadow-sm border-0 mb-5">
      <div class="card-body p-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="statsChartTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="harvested-tab" data-bs-toggle="tab"
                    data-bs-target="#harvested-pane" type="button" role="tab">
              <i class="bi bi-graph-up"></i> Harvested
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="percentage-tab" data-bs-toggle="tab"
                    data-bs-target="#percentage-pane" type="button" role="tab">
              <i class="bi bi-percent"></i> Percentage
            </button>
          </li>
          {% if not all_mortality_zero %}
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="mortality-tab" data-bs-toggle="tab"
                      data-bs-target="#mortality-pane" type="button" role="tab">
                <i class="bi bi-heartbreak"></i> Mortality
              </button>
            </li>
          {% endif %}
          {% if not all_feed_zero %}
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="feeds-tab" data-bs-toggle="tab"
                      data-bs-target="#feeds-pane" type="button" role="tab">
                <i class="bi bi-basket"></i> Feeds
              </button>
            </li>
          {% endif %}
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
          <div class="tab-pane fade show active" id="harvested-pane" role="tabpanel">
            <div class="chart-container"><canvas id="harvestedChart"></canvas></div>
          </div>
          <div class="tab-pane fade" id="percentage-pane" role="tabpanel">
            <div class="chart-container"><canvas id="percentageChart"></canvas></div>
          </div>
          {% if not all_mortality_zero %}
            <div class="tab-pane fade" id="mortality-pane" role="tabpanel">
              <div class="chart-container"><canvas id="mortalityChart"></canvas></div>
            </div>
          {% endif %}
          {% if not all_feed_zero %}
            <div class="tab-pane fade" id="feeds-pane" role="tabpanel">
              <div class="chart-container"><canvas id="feedsChart"></canvas></div>
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    {% if all_mortality_zero and all_feed_zero %}
      <div class="alert alert-info text-center mb-0">
        <i class="bi bi-info-circle"></i>
        No mortality or feed data available for the selected range.
      </div>
    {% endif %}

    <!-- JSON for charts -->
    {{ flock_stats_json|json_script:"flockStatsData" }}
  {% endif %}

  <!-- Stats Table -->
  <section id="stats-table" class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light border-top-0">
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Harvested</th>
            <th>Percentage</th>
            <th>Notes</th>
            <th>Mortality</th>
            <th>Feed</th>
            <th>Inc/Dec</th>
            {% if not flock.is_culled %}<th></th>{% endif %}
          </tr>
        </thead>
        <tbody id="stats-body">
          {% include "components/stats_rows.html" with stats=stats %}
        </tbody>
      </table>

      <!-- Load More Button -->
      <div class="text-center my-4">
        <button id="load-more-btn" class="btn btn-outline-secondary" data-page="2" data-loading="false">
          Load moreâ€¦
        </button>
      </div>
    </div>
  </section>

  {% block modal %}
    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notesModalLabel">Notes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="notesModalBody" class="mb-0 text-wrap"></p>
          </div>
        </div>
      </div>
    </div>
  {% endblock modal %}
</div>

<!-- Scroll to Top Button -->
<button id="scroll-to-top"
        class="scroll-top-btn"
        title="Back to top"
        aria-label="Back to top">
  <i class="bi bi-arrow-up-short"></i>
  <span>Top</span>
</button>

{% endblock content %}

{% block inline_javascript %}
{{ block.super }}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
  // Date filters logic
  const dayInput = document.getElementById('day');
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');

  dayInput?.addEventListener('input', () => {
    if (dayInput.value) {
      startDateInput.value = '';
      endDateInput.value = '';
    }
  });

  startDateInput?.addEventListener('change', () => {
    dayInput.value = '';
    if (startDateInput.value) {
      endDateInput.min = startDateInput.value;
      if (endDateInput.value && endDateInput.value < startDateInput.value) {
        endDateInput.value = "";
      }
    } else {
      endDateInput.min = "{{ min_date|date:'Y-m-d' }}";
    }
  });

  endDateInput?.addEventListener('change', () => {
    dayInput.value = '';
  });

  // Charts rendering
  document.addEventListener('DOMContentLoaded', () => {
    const charts = {};
    const flockStats = JSON.parse(document.getElementById('flockStatsData').textContent);
    const labels = flockStats.map(s => new Date(s.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
    const harvestedData = flockStats.map(s => s.harvested || 0);
    const percentageData = flockStats.map(s => s.percentage || 0);
    const mortalityData = flockStats.map(s => s.mortality || 0);
    const feedData = flockStats.map(s => s.feed_consumed || 0);

    function renderChart(id, config) {
      const canvas = document.getElementById(id);
      if (!canvas) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(canvas, config);
    }

    renderChart('harvestedChart', {
      type:'line',
      data:{labels,datasets:[{label:'Harvested',data:harvestedData,borderColor:'blue',backgroundColor:'rgba(54,162,235,0.25)',fill:true,tension:0.4}]},
      options:{responsive:true,maintainAspectRatio:false}
    });

    renderChart('percentageChart', {
      type:'line',
      data:{labels,datasets:[{label:'Production %',data:percentageData,borderColor:'orange',backgroundColor:'rgba(255,206,86,0.25)',fill:true,tension:0.4}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}
    });

    renderChart('mortalityChart', {
      type:'bar',
      data:{labels,datasets:[{label:'Mortality',data:mortalityData,backgroundColor:'rgba(220,53,69,0.65)'}]},
      options:{responsive:true,maintainAspectRatio:false}
    });

    renderChart('feedsChart', {
      type:'line',
      data:{labels,datasets:[{label:'Feed Consumed',data:feedData,borderColor:'green',backgroundColor:'rgba(25,135,84,0.25)',fill:true,tension:0.4}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("load-more-btn");
  const tableBody = document.getElementById("stats-body");
  if (!btn || !tableBody) return;

  let isLoading = false;
  let userHasScrolled = false;

  function loadNextPage() {
    if (isLoading || btn.disabled) return;

    isLoading = true;
    btn.innerText = "Loadingâ€¦";

    const page = btn.dataset.page;
    const url = new URL(window.location.href);
    url.searchParams.set("page", page);

    fetch(url.toString(), {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(res => res.json())
      .then(data => {
        if (data.html) {
          // ðŸ›‘ De-duplicate rows by stats.id
          const temp = document.createElement("tbody");
          temp.innerHTML = data.html;

          temp.querySelectorAll("tr[data-stats-id]").forEach(row => {
            const id = row.dataset.statsId;
            if (!tableBody.querySelector(`tr[data-stats-id="${id}"]`)) {
              tableBody.appendChild(row);
            }
          });
        }

        if (!data.has_next) {
          btn.innerText = "No more records";
          btn.disabled = true;
        } else {
          btn.dataset.page = parseInt(page, 10) + 1;
          btn.innerText = "Load moreâ€¦";
        }
      })
      .catch(() => {
        btn.innerText = "Load moreâ€¦";
      })
      .finally(() => {
        isLoading = false;
      });
  }

  // Manual click always works
  btn.addEventListener("click", loadNextPage);

  // Detect first real scroll
  window.addEventListener("scroll", () => {
    userHasScrolled = true;
  }, { once: true });

  // Auto-load ONLY after user scrolls
  window.addEventListener("scroll", () => {
    if (!userHasScrolled || isLoading || btn.disabled) return;

    const rect = btn.getBoundingClientRect();
    if (rect.top <= window.innerHeight + 50) {
      loadNextPage();
    }
  });
});
</script>

<script src="{% static 'js/scroll_to_top.js' %}"></script>

{% endblock inline_javascript %}
